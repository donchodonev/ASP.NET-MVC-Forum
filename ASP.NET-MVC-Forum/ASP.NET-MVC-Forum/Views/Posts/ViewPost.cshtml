@model ASP.NET_MVC_Forum.Models.Post.ViewPostViewModel;
@using System.Security.Claims;
@{
    ViewData["Title"] = "View Post";
    var userUsername = this.User.Identity.Name;
}




<link rel="stylesheet" href="~/css/postsAll.css" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />

<style>

    body {
        background: #eee
    }

    .bdge {
        height: 21px;
        background-color: orange;
        color: #fff;
        font-size: 11px;
        padding: 8px;
        border-radius: 4px;
        line-height: 3px
    }

    .comments {
        text-decoration: underline;
        text-underline-position: under;
        cursor: pointer
    }

    .dot {
        height: 7px;
        width: 7px;
        margin-top: 3px;
        background-color: #bbb;
        border-radius: 50%;
        display: inline-block
    }

    .hit-voting:hover {
        color: blue
    }

    .hit-voting {
        cursor: pointer
    }

    .servicedrop {
        transition-delay: 1s
    }

    .action-collapse {
        cursor: pointer
    }
</style>

<div class="container-fluid mt-100">
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-3 mt-3">
                <div class="card-footer d-flex flex-wrap justify-content-between align-items-center px-0 pt-0 pb-3">
                    <div class="ml-2 pt-3">
                        <h5 class="text-dark font-weight-bold">@Model.Title</h5>
                    </div>
                    <div class="mr-2 pt-3 text-center">
                        <a type="button" href='javascript:history.go(-1)' class="btn btn-secondary float-sm-right"><i class="ion ion-md-create"></i>Go Back</a>
                    </div>
                </div>
                <div class="card-body">
                    @Html.Raw(Model.HtmlContent)
                </div>

                <div class="card-header">
                    <div class="media flex-wrap w-100 align-items-center">
                        <img src="~/img/defaultUserImage.png" class="d-block ui-w-40 rounded-circle" alt="">

                        <div class="media-body ml-3">
                            <a href="javascript:void(0)" data-abc="true">@Model.UserUsername</a>
                            <div class="text-muted small">@Model.PostCreationDate</div>
                        </div>
                        <div class="text-muted small ml-3">
                            <div>Member since <strong>@Model.UserMemberSince</strong></div>
                            <div><strong>@Model.UserPostsCount</strong> posts</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="px-4 pt-3 text-center">
    <a type="button" href='javascript:history.go(-1)' class="btn btn-secondary justify-content-center"><i class="ion ion-md-create"></i>Go Back</a>
</div>

<div class="container mt-5 mb-5">
    <div class="d-flex justify-content-center row">
        <div class="d-flex flex-column col-md-8">
            <div class="d-flex flex-row align-items-center text-left comment-top p-2 bg-white border-bottom px-4">
                <div class="profile-image"><img class="rounded-circle" src="https://i.imgur.com/06EM6Iy.jpg" width="70"></div>
                <div class="d-flex flex-column-reverse flex-grow-0 align-items-center votings ml-1"><i class="fa fa-sort-up fa-2x hit-voting"></i><span>127</span><i class="fa fa-sort-down fa-2x hit-voting"></i></div>
                <div class="d-flex flex-column ml-3">
                    <div class="d-flex flex-row post-title">
                    </div>
                    <div class="d-flex flex-row align-items-center align-content-center post-title"><span class="mr-2 comments">13 comments&nbsp;</span><span class="mr-2 dot"></span><span>6 hours ago</span></div>
                </div>
            </div>
            <div class="coment-bottom bg-white p-2 px-4">
                @if (this.User.Identity.IsAuthenticated)
                {
                    <form method="post" id="commentsForm">
                        <div class="d-flex flex-row add-comment-section mt-4 mb-4">
                            <img class="img-fluid img-responsive rounded-circle mr-2" src="https://i.imgur.com/KLeobJk.jpg" width="38">
                            <input type="text" class="form-control mr-3" placeholder="Add comment" id="comment">
                            <button id="sendComment" class="btn btn-primary">Comment</button>
                        </div>
                    </form>
                }
                else
                {
                    <div class="text-center">
                        <p>Please <a href="/Identity/Account/Login">Login</a> if you wish to post a comment</p>
                    </div>
                }
                <div class="collapsable-comment">
                    <div class="d-flex flex-row justify-content-between align-items-center action-collapse p-2" data-toggle="collapse" aria-expanded="false" aria-controls="collapse-1" href="#collapse-1"><span>Comments</span><i id="serviceDrop" class="fa fa-chevron-down servicedrop"></i></div>
                    <div id="collapse-1" class="collapse">
                        @*-------------COMMENT--------------*@
                        <div class="commented-section mt-2">
                            <div class="commented-section mt-2 commentsArray">

                            </div>
                        </div>
                        @*-------------COMMENT--------------*@
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* I know this js is ugly but I know no JS or jQuery... yet*@

@section Scripts{
    <script>
        $("button#sendComment").click(function (e) {
            e.preventDefault();
            var token = $("#commentsForm [name=__RequestVerificationToken]").val();
            var data = {
        CommentText: $("input#comment").val()
        , UserId:'0'
        , PostId: '@Model.PostId'
    };
        $.ajax({
            type: 'POST',
            contentType: 'application/json',
            url: '/api/comments',
            data: JSON.stringify(data),
            dataType: "json",
            headers: { 'X-CSRF-TOKEN': token },
            success: function (returnData) {
                var el = document.getElementById('serviceDrop');
                $("input#comment").val(''),
                    $('.collapse').collapse('show')
                if (el.classList.contains('fa-chevron-up')) {
                    $('<div class="d-flex flex-row align-items-center commented-user"><h5 class="mr-2">' + returnData.username + '</h5 ></div ><div class="comment-text-sm"><span>' + returnData.commentText + '</span></div>').prependTo('.commentsArray');
                }
            }
        });
    });
    </script>

    <script>
        $(document).ready(function () {
            $('#collapse-1').on('shown.bs.collapse', function () {
                 $.getJSON('/api/comments', { postId: '@Model.PostId' },
                    function (comments) {
                        for (var i = 0; i < comments.length; i++) {
                            var currentComment = (comments[i].content);
                            var currentCommentAuthor = comments[i].commentAuthor;
                            $('<div class="d-flex flex-row align-items-center commented-user"><h5 class="mr-2">' + currentCommentAuthor + '</h5 ></div ><div class="comment-text-sm"><span>' + currentComment + '</span></div>').appendTo('.commentsArray');
                        }
                    }
                )
                $(".servicedrop").addClass('fa-chevron-up').removeClass('fa-chevron-down');
            });
            $('#collapse-1').on('hidden.bs.collapse', function () {
                $(".servicedrop").addClass('fa-chevron-down').removeClass('fa-chevron-up');
                $("div.comment-text-sm").remove();
                $("div.commented-user").remove();
            });
        });
    </script>

}
